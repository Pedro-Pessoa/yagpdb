{{define "cp_youtube"}}

{{template "cp_head" .}}

<header class="page-header">
    <h2>Youtube upload feeds</h2>
</header>

{{template "cp_alerts" .}}

<div class="row">
    <div class="col-lg-12">
        <section class="card">
            <header class="card-header">
                <h2 class="card-title">New feed</h2>
            </header>
            <div class="card-body">
                <form class="" method="post" action="/manage/{{.ActiveGuild.ID}}/youtube">
                    <p><b>Provide either channel ID OR username.</b> Only one of them, not both.<br>
                        When you go to the channel page, if the address bar has for example
                        <code>youtube.com/user/h3h3Productions</code> then the username is h3h3Productions<br>
                        if it's <code>youtube.com/channel/UCt-ERbX-2yA6cAqfdKOlUwQ</code> then the id is
                        <code>UCt-ERbX-2yA6cAqfdKOlUwQ</code><br>
                        The announce message works like a custom command<br>
                        For any questions join the support server</p>
                    <div class="form-group">
                        <label for="yt-channel-id">Youtube Channel ID</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-prepend">
                                <span class="input-group-text">youtube.com/channel/</span>
                            </span>
                            <input type="text" class="form-control" id="yt-channel-id" name="YoutubeChannelID">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="yt-channel-user">Youtube Username</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-prepend">
                                <span class="input-group-text">youtube.com/user/</span>
                            </span>
                            <input type="text" class="form-control" id="yt-channel-user" name="YoutubeChannelUser">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="channel">Discord Channel</label>
                        <select id="channel" class="form-control" name="DiscordChannel" data-requireperms-send>
                            {{textChannelOptions .ActiveGuild.Channels nil false ""}}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="youtube_msg">Announce Message (<span class="announce-length-counter">x</span>/1000)</label>
                        <textarea class="form-control" rows="5" id="youtube_msg" name="youtube_msg" oninput="onCCChanged(this)">{{.YoutubeMsg}}</textarea>
                        <p class="help-block">
                            Extra template data available is <code>{{"{{.URL}}"}}</code>, <code>{{"{{.ChannelName}}"}}</code>, <code>{{"{{.VideoID}}"}}</code> and <code>{{"{{.ChannelID}}"}}</code>.
                        </p>
                    </div>
                    <button type="submit" class="btn btn-success">Add</button>
                </form>
            </div>
        </section>
        <section class="card">
            <header class="card-header">
                <h2 class="card-title">Current subscribed channels</h2>
            </header>
            <div class="card-body">
                {{$dot := .}}
                {{range .Subs}}
                    <form id="sub-item-{{.ID}}" data-async-form method="post" action="/manage/{{$dot.ActiveGuild.ID}}/youtube/{{.ID}}/update">
                        <input type="text" class="hidden form-control" name="id" value="{{.ID}}">
                    </form>
                {{end}}

                <table class="table table-responsive-md table-sm mb-0">
                    <thead>
                        <tr>
                            <th>Youtube</th>
                            <th>Discord channel</th>
                            <th>Announce Message</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .Subs}}
                            <tr>
                                <td>
                                    <p class="form-control-static">
                                        <b>{{.YoutubeChannelName}}</b> - <code>{{.YoutubeChannelID}}</code>
                                    </p>
                                </td>
                                <td>
                                    <select form="sub-item-{{.ID}}" id="channel" class="form-control" name="DiscordChannel" data-requireperms-embed>
                                        {{textChannelOptions $dot.ActiveGuild.Channels .ChannelID false ""}}
                                    </select>
                                </td>
                                <td>
                                    <textarea form="sub-item-{{.ID}}" id="youtube_msg" name="youtube_msg" class="form-control" rows="5" data-requireperms-embed oninput="onCCChanged(this)">{{.YoutubeMsg}}</textarea>
                                    <label for="youtube_msg">Announce Message (<span class="announce-length-counter">x</span>/1000)</label>
                                </td>
                                <td>
                                    <button form="sub-item-{{.ID}}" type="submit" class="btn btn-success" formaction="/manage/{{$dot.ActiveGuild.ID}}/youtube/{{.ID}}/update" data-async-form-alertsonly>Save</button>
                                    <button form="sub-item-{{.ID}}" type="submit" class="btn btn-danger" formaction="/manage/{{$dot.ActiveGuild.ID}}/youtube/{{.ID}}/delete">Delete</button>
                                </td>
                            </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        </section>
    </div>
</div>

<script>
    $(function () {
        var idInput = $("#yt-channel-id");
        var userInput = $("#yt-channel-user");

        userInput.on("input", function (arg) {
            if (userInput.val().length > 0) {
                idInput.attr("disabled", true);
            } else {
                idInput.attr("disabled", false);
            }
        })


        idInput.on("input", function (arg) {
            if (idInput.val().length > 0) {
                userInput.attr("disabled", true);
            } else {
                userInput.attr("disabled", false);
            }
        })
    })
</script>

<script type="text/javascript">
    function onCCChanged(textArea) {
        var textAreas = textArea.parentElement.querySelectorAll('textarea');
        var combinedLength = 0;

        textAreas.forEach(function (elem) {
            combinedLength += elem.value.length;
        });

        var display = textArea.parentElement.querySelector(".announce-length-counter");
        display.textContent = combinedLength;

        if (combinedLength > 1000) {
            display.classList.add("text-danger");
        } else {
            display.classList.remove("text-danger");
        }
    }
</script>

{{template "cp_footer" .}}

{{end}}